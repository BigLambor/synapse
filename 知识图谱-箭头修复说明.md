# 知识图谱箭头修复说明

## 🎯 修复内容

### 问题1：连线不可见 ✅
**原因**：
- 线条透明度太低（`stroke-opacity: 0.4`）
- 线条太细（`stroke-width: 1-3`）
- 深色背景下几乎看不见

**解决方案**：
- 透明度提升至 `0.7`（提升75%）
- 线条宽度**加倍**：`(edge.weight || 1) * 2`
- 标签颜色改为白色，透明度 `0.8`
- 悬停效果：透明度 `1.0`，宽度加粗至 `6`

### 问题2：关系筛选器不可交互 ✅
**原因**：
- 右上角只是静态图例，没有点击事件

**解决方案**：
- 添加 `selectedEdgeTypes` 状态管理
- 将静态图例改为可点击按钮
- 实现 `toggleEdgeTypeFilter()` 方法
- 点击按钮有视觉反馈（高亮显示）

### 问题3：箭头不显示 ✅
**原因**：
- SVG marker 配置使用了 `markerUnits="strokeWidth"`，导致箭头缩放不正确
- 使用动态生成的 marker ID，可能有命名冲突
- 箭头被节点圆圈遮挡

**解决方案**：
1. **重新定义箭头标记（Marker）**：
   - 改用 `markerUnits="userSpaceOnUse"`（用户空间单位）
   - 为每种关系类型创建固定的箭头标记
   - 箭头尺寸：`12x12` 像素
   - 参考点：`refX="10", refY="6"`

2. **箭头颜色映射**：
   ```javascript
   - arrow-6366f1  // 蓝色 - 依赖（depends_on）
   - arrow-10b981  // 绿色 - 解决（solves）
   - arrow-ef4444  // 红色 - 影响（causes）
   - arrow-8b5cf6  // 紫色 - 实现（implements）
   - arrow-94a3b8  // 灰色 - 相关（related_to）
   - arrow-f59e0b  // 橙色 - 竞争（competes_with）
   ```

3. **线条端点计算**：
   - 添加 `getEdgePoints()` 函数
   - 从节点边缘开始绘制，避免被节点遮挡
   - 起点：节点中心 + 节点半径 + 2px
   - 终点：节点中心 - 节点半径 - 12px（留给箭头的空间）

## 📊 技术实现细节

### 1. 箭头标记定义（SVG Marker）

```vue
<marker
  id="arrow-6366f1"
  markerWidth="12"
  markerHeight="12"
  refX="10"
  refY="6"
  orient="auto"
  markerUnits="userSpaceOnUse"
>
  <path d="M0,0 L0,12 L12,6 z" fill="#6366f1" />
</marker>
```

**关键参数**：
- `markerUnits="userSpaceOnUse"`：使用绝对单位，不随线条宽度缩放
- `refX="10"`：箭头尖端位置，确保尖端对准线条终点
- `orient="auto"`：箭头自动旋转以对齐线条方向
- `path d="M0,0 L0,12 L12,6 z"`：三角形箭头路径

### 2. 线条端点计算算法

```javascript
const getEdgePoints = (edge) => {
  // 1. 获取源节点和目标节点
  const sourceNode = nodesWithPositions.value.find(n => n.id === edge.source)
  const targetNode = nodesWithPositions.value.find(n => n.id === edge.target)
  
  // 2. 计算方向向量
  const dx = tx - sx
  const dy = ty - sy
  const distance = Math.sqrt(dx * dx + dy * dy)
  
  // 3. 计算单位向量
  const ux = dx / distance
  const uy = dy / distance
  
  // 4. 从节点边缘开始，留出空间
  const sourceRadius = (sourceNode.size || 40) / 2 + 2
  const targetRadius = (targetNode.size || 40) / 2 + 12
  
  // 5. 返回调整后的起点和终点
  return {
    x1: sx + ux * sourceRadius,
    y1: sy + uy * sourceRadius,
    x2: tx - ux * targetRadius,
    y2: ty - uy * targetRadius
  }
}
```

### 3. 关系类型筛选功能

```javascript
// 状态管理
const selectedEdgeTypes = ref(['depends_on', 'solves', 'causes', ...])

// 切换筛选
const toggleEdgeTypeFilter = (edgeType) => {
  const index = selectedEdgeTypes.value.indexOf(edgeType)
  if (index > -1) {
    selectedEdgeTypes.value.splice(index, 1)  // 取消选中
  } else {
    selectedEdgeTypes.value.push(edgeType)    // 选中
  }
}

// 过滤可见边
const visibleEdges = computed(() => {
  return props.graphData.edges.filter(
    edge => selectedEdgeTypes.value.includes(edge.type)
  )
})
```

## 🎨 视觉效果增强

### 线条样式
- **宽度**：`(weight || 1) * 2` 像素（2-6px）
- **透明度**：`0.7`（正常），`1.0`（悬停）
- **颜色**：根据关系类型自动匹配

### 悬停效果
```css
.edge-group:hover line {
  stroke-opacity: 1 !important;
  stroke-width: 6 !important;
}

.edge-group:hover text {
  opacity: 1 !important;
  font-weight: 600;
}
```

## 📱 使用方法

### 查看箭头方向
1. **观察箭头颜色**识别关系类型
2. **箭头方向**表示关系的流向：
   - `A → B` 表示 "A 依赖 B" 或 "A 解决 B"

### 使用关系筛选
1. 点击右上角的关系类型按钮（依赖/解决/影响）
2. 激活状态：按钮显示对应颜色
3. 未激活状态：按钮显示灰色
4. 支持多选：可同时查看多种关系

### 交互技巧
- **悬停在连线上**：线条加粗，关系标签更明显
- **点击节点**：查看该节点的连接数和详细信息
- **组合筛选**：节点类型 + 关系类型 = 精准分析

## 🔍 关系类型说明

| 关系类型 | 颜色 | 含义 | 示例 |
|---------|------|------|------|
| depends_on | 🔵 蓝色 | 依赖关系 | "语音唤醒" → "BERT模型" |
| solves | 🟢 绿色 | 解决关系 | "本地唤醒词模型" → "唤醒响应慢" |
| causes | 🔴 红色 | 影响/导致 | "唤醒响应慢" → "语音唤醒" |
| implements | 🟣 紫色 | 实现关系 | "智能座舱系统" → "语音唤醒" |
| related_to | ⚪ 灰色 | 相关关系 | "HMI界面" → "情境感知" |
| competes_with | 🟠 橙色 | 竞争关系 | "智能座舱系统" → "Tesla Model S" |

## ✨ 效果对比

### 修复前
- ❌ 看不到连线
- ❌ 看不到箭头
- ❌ 无法筛选关系类型
- ❌ 不知道关系方向

### 修复后
- ✅ 连线清晰可见
- ✅ 箭头显示正确
- ✅ 可以点击筛选关系
- ✅ 箭头明确指示方向
- ✅ 颜色区分关系类型
- ✅ 悬停有交互反馈

## 🚀 后续优化建议

1. **性能优化**：大量节点时可以考虑使用 Canvas 替代 SVG
2. **高亮联动**：点击节点时高亮相关的所有连线
3. **关系强度**：线条粗细可以表示关系强度
4. **动画效果**：连线可以添加流动动画表示数据流向
5. **导出功能**：支持导出为图片或 SVG 文件

